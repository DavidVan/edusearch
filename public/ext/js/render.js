/**
 * 
 * Oposum - Video tutorial summary app.
 * 
 * When a youtube video page is loaded, render.js renders the proper UI onto
 * the page to allow users to generate the summary.
 */

// Waits for page to load. Temporary hack bc YT uses
// asynchronous loading and idk how to do this lol
setTimeout(loadButton, 2000);

// STYLES
var style = Object.create(null);
style.body = 'font-size:14px; margin-top:40px;';
style.h1 = 'font-size:18px;';
style.button = 'padding:13px; background:#84CBE3; color:white;' +
    'text-transform:uppercase; border:none; font-weight:bold;' +
    'cursor:pointer; float:right; margin-left:10px;';
style.sub = 'font-size:10px; color:gray;';
// Video ID
var videoId = getId(window.location.href);
// Whether the video has been clicked?
var opossum_clicked = false; // TODO: Show as already saved after checking db

// ================= FUNCTIONS ===================
/**
 * Loads the button onto the page.
 */
function loadButton() {
  console.log('loading button');
  var menuContainer = document.getElementById('menu-container');
  var header = document.getElementsByTagName('ytd-video-primary-info-renderer')[0];

  if (!header) {
    console.warn('No header text detected.');
    return;
  }

  console.log('Loading button...');

  // Injects the contents.
  $('#meta-contents').append(
      '<div id="oposum">' +
        '<div id="opossum_text">' +
          '<span id="op_title" style="float:left">' +
            '<span style="' + style.h1 + '">Summary</span><br>' +
            '<span style="' + style.sub + '">Generated by oposum</span><br>' +
          '</span>' +
          '<button id="save_opossum" style="display:none;' + style.button + '">Save Summary</button>' + 
          '<button id="opossum_button" style="' + style.button + '">Summarize</button><br><br>' +
          '<p style="' + style.body + '">Click to generate a quick summary of this video.</p><br><br>' +
        '</div>' +
      '</div><hr style="border:0.5px solid #EDEDED; width:100%;"><br>');

  // Event listener for showing the summary.
  $('#opossum_button').click(function() {
    opossum_clicked = !opossum_clicked;

    if (opossum_clicked) {
      getSummary(videoId, function(data) {
        $('#opossum_text p').html(data);
      });
      $('#opossum_button').html('Unsummarize');
      $('#save_opossum').show();
    } else {
      $('#opossum_text p').html('Click to generate a quick summary of this video.');
      $('#opossum_button').html('Summarize');
      $('#save_opossum').hide();
    }
  });

  // Saves summary to local storage.
  $('#save_opossum').click(function() {
    $.ajax({
      url: 'https://www.googleapis.com/youtube/v3/videos?id=' + videoId + '&key=AIzaSyB2Ma4BNgsk8nQYKZap9q77VbNl75l9mF8&fields=items(snippet(title))&part=snippet',
      success: function(data) {
        store(data.items[0].snippet.title, $('#opossum_text p').html(), function() {});
      }
    });
    $('#save_opossum').html('Saved');
    $('#save_opossum').css({
      'background': '#C1D1D6',
      'disabled': 'true'
    });
  });
};

function store(title, content, fcn) {
  // Save it using the Chrome extension storage API.
  var summaries = [];
  chrome.storage.sync.get(['summaries'], function(items) {
    summaries = items.summaries;
    summaries.push({
      'title': title,
      'content': content
    });
    chrome.storage.sync.set({
      'summaries': summaries
    }, fcn);
  });
}

/**
 * Gets summary of currently playing video.
 */
function getSummary(video_id, grabText) {
  console.log('Retrieving summary...');
  $.ajax({
    method: 'POST',
    url: 'https://edusearch-eleng555.c9users.io/' + video_id,
    dataType: 'text',
    success: function(data) {
      console.log('Summary retrieved!');
      grabText(data);
    }
  });
}

/**
 * Given a youtube URL, gets the id of the video. If it is
 * not a valid youtube video, returns null.
 */
function getId(url) {
  var spliced = url.split('/watch?v=');
  if (spliced.length > 1) {
    spliced[1] = spliced[1].replace(/\?t=*/g, '');
    return spliced[1];
  } else {
    return null;
  }
}
